<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs
    	title="Kodak OpenID Login"
    	author="Janrain, Inc."
    	directory_title="RPX" 
    	description="Gadget to allow login with OpenID using Janrain Engage">
    	<Optional feature="gadget-directory">
        	<Param name="categories">
            	JIRA
          	</Param>
      	</Optional>
      	<Require feature="setprefs" />
		<Require feature="settitle"/>
		<Require feature="views" />
		<Optional feature="atlassian.util" />
		<Require feature="minimessage" />
 		<Require feature="dynamic-height" />
      	#supportedLocales("gadget.common")
  	</ModulePrefs>
    <UserPref name="isConfigured" datatype="hidden" default_value="false"/>
    <Content type="html">
        <![CDATA[
        #requireResource("com.atlassian.jira.gadgets:common")
		#includeResources()
 			
 			
		<script type="text/javascript">
 			(function () {
 				var gadget = AJS.Gadget ({
 					baseUrl: "__ATLASSIAN_BASE_URL__",
					view: {
 						enableReload: true,
 						onResizeAdjustHeight: true,
 						template: function(args) {		
 							var gadget = this;
 							this.getView().empty();
	      	
 							var username = args.username;
 							var str = '<div style="margin:10px;">';
 			
 							if(username === "")
 							{
 								str += 'Login with your OpenID\
									   	<form method="POST" target="_top" action="' +
									   	args.startUrl +
									   	'">\
									   	<input name="openid_identifier">\
									   	<input type="submit" value="login">\
									   	</form>\
									   	</div>';
							}
							else
							{
								str += '<p>You are signed in as ' +
										args.username +
										'.  <a href="' +
										"__ATLASSIAN_BASE_URL__" +
										'/logout">Sign Out.</a></p>\
										</div>';
							}
											
 							this.getView().html(str);
   										
			                gadget.resize();
 						},
 						args: [{
 							key: "startUrl",
 							ajaxOptions: function() {
 								return { 
 									url: "/rest/com-janrain-rpx-rest/1.0/manager/startUrl",
 									dataType: "text",
 									cache: false
 									//, 
 									//beforeSend: function() { alert("before"); },
   									//complete: function() { alert("complete"); },
 									//error: function(a, b, c) { alert("error: " + a); },
 									//success: function(a, b, c) { alert("success"); }
 								}
 							}	
 						},
 						{
 							key: "username",
 							ajaxOptions: function() {
 								return { 
 									url: "/rest/com-janrain-rpx-rest/1.0/manager/username",
 									dataType: "text",
 									cache: false
 									//, 
 									//beforeSend: function() { alert("before"); },
   									//complete: function() { alert("complete"); },
 									//error: function(a, b, c) { alert("error: " + a); },
 									//success: function(a, b, c) { alert("success"); }
 								}
 							}	
 						}]
 					}
 				});
 			})();	
		</script>
        ]]>
    </Content>
</Module>
